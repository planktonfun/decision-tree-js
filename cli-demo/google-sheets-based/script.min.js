var fs=require("fs"),readline=require("readline"),google=require("googleapis"),googleAuth=require("google-auth-library"),desobj=require("./decision-tree.js"),util=require("util"),basepath="../json_files/",SCOPES=["https://www.googleapis.com/auth/spreadsheets.readonly"],TOKEN_DIR=(process.env.HOME||process.env.HOMEPATH||process.env.USERPROFILE)+"/.credentials/",TOKEN_PATH=TOKEN_DIR+"sheets.googleapis.com-nodejs-quickstart.json";
fs.readFile("client_id.json",function(b,c){b?console.log("Error loading client secret file: "+b):authorize(JSON.parse(c),listMajors)});function authorize(b,c){var d=b.installed.client_secret,e=b.installed.client_id,a=b.installed.redirect_uris[0],f=new (new googleAuth).OAuth2(e,d,a);fs.readFile(TOKEN_PATH,function(a,b){a?getNewToken(f,c):(f.credentials=JSON.parse(b),c(f))})}
function getNewToken(b,c){var d=b.generateAuthUrl({access_type:"offline",scope:SCOPES});console.log("Authorize this app by visiting this url: ",d);var e=readline.createInterface({input:process.stdin,output:process.stdout});e.question("Enter the code from that page here: ",function(a){e.close();b.getToken(a,function(a,e){a?console.log("Error while trying to retrieve access token",a):(b.credentials=e,storeToken(e),c(b))})})}
function storeToken(b){try{fs.mkdirSync(TOKEN_DIR)}catch(c){if("EEXIST"!=c.code)throw c;}fs.writeFile(TOKEN_PATH,JSON.stringify(b));console.log("Token stored to "+TOKEN_PATH)}var complete=2,sheet_columns,sheet_rows;function getConfigValues(b,c,d,e){google.sheets("v4").spreadsheets.values.get({auth:b,spreadsheetId:c,range:d+"!B1:B2"},function(a,b){a?console.log("The API returned an error: "+a):(0==b.values.length&&console.log("No data found."),e({columns:b.values[0],rows:b.values[1]}))})}
function listMajors(b){var c=google.sheets("v4");getConfigValues(b,"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk","Wine",function(d){console.log(d);c.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",range:"Wine!"+d.columns},function(b,a){if(b)console.log("The API returned an error: "+b);else{var c=a.values;0==c.length?console.log("No data found."):(complete--,sheet_columns=c[0],start())}});c.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",
range:"Wine!"+d.rows},function(b,a){if(b)console.log("The API returned an error: "+b);else{var c=a.values;0==c.length?console.log("No data found."):(complete--,sheet_rows=c,start())}})})}function isNumeric(b){return!isNaN(b)}
var start=function(){function b(a){if(a.category)return[' "',a.category,'"'].join("");var c={},d=['"',a.attribute," ",a.predicateName," ",a.pivot,' ?"'].join("");c[d]={yes:b(a.match),no:b(a.notMatch)};return c}function c(a){return a.category?['<ul><li><a href="#"><b>',a.category,"</b></a></li></ul>"].join(""):['<ul><li><a href="#"><b>',a.attribute," ",a.predicateName," ",a.pivot,' ?</b></a><ul><li><a href="#">yes</a>',c(a.match),'</li><li><a href="#">no</a>',c(a.notMatch),"</li></ul></li></ul>"].join("")}
if(!(0<complete)){for(var d=desobj.dt,e=[],a=0;a<sheet_rows.length;a++){for(var f=sheet_rows[a],g={},h=0;h<sheet_columns.length;h++)isNumeric(f[h])?g[sheet_columns[h].trim()]=parseFloat(f[h]):g[sheet_columns[h].trim()]=f[h];e.push(g)}fs.writeFile(basepath+"data.json",JSON.stringify(g),function(a){if(a)return console.log(a);console.log("The file was saved!")});a={trainingSet:e,categoryAttr:"action",ignoredAttributes:[]};fs.writeFile(basepath+"config.json",JSON.stringify(a),function(a){if(a)return console.log(a);
console.log("The file was saved!")});f=new d.DecisionTree(a);g=new d.RandomForest(a,3);a=e[0];fs.writeFile(basepath+"input.json",JSON.stringify(a),function(a){if(a)return console.log(a);console.log("The file was saved!")});d=f.predict(a);g=g.predict(a);console.log(JSON.stringify(a,null,0));console.log(JSON.stringify(d,null,0));console.log(JSON.stringify(g,null,0));a=b(f.root);console.log(util.inspect(a,!1,null));fs.writeFile(basepath+"tree.json",JSON.stringify(a),function(a){if(a)return console.log(a);
console.log("The file was saved!")});fs.writeFile(basepath+"tree.html",'<head><link rel="stylesheet" href="../base.css"></head><body><div class="weee" style="    width: 100%;    height: 100%;    overflow-x: scroll;    overflow-y: scroll;"><div class="tree" id="displayTree" style="    width: 9000px;    height: 9000px;"><div class="tree" id="displayTree">'+c(f.root)+"</div></div>",function(a){if(a)return console.log(a);console.log("The file was saved!")});d=0;for(a=e.length-1;0<=a;a--)g=e[a].action,
h=e[a],h.action="",f.predict(h)!=g&&d++;console.log("Error Rate:"+d/e.length*100+"%")}};
