var fs=require("fs"),readline=require("readline"),google=require("googleapis"),googleAuth=require("google-auth-library"),desobj=require("./decision-tree.js"),util=require("util"),basepath="../json_files/",SCOPES=["https://www.googleapis.com/auth/spreadsheets.readonly"],TOKEN_DIR=(process.env.HOME||process.env.HOMEPATH||process.env.USERPROFILE)+"/.credentials/",TOKEN_PATH=TOKEN_DIR+"sheets.googleapis.com-nodejs-quickstart.json";
fs.readFile("client_id.json",function(b,d){b?console.log("Error loading client secret file: "+b):authorize(JSON.parse(d),listMajors)});function authorize(b,d){var f=b.installed.client_secret,e=b.installed.client_id,a=b.installed.redirect_uris[0],g=new (new googleAuth).OAuth2(e,f,a);fs.readFile(TOKEN_PATH,function(a,b){a?getNewToken(g,d):(g.credentials=JSON.parse(b),d(g))})}
function getNewToken(b,d){var f=b.generateAuthUrl({access_type:"offline",scope:SCOPES});console.log("Authorize this app by visiting this url: ",f);var e=readline.createInterface({input:process.stdin,output:process.stdout});e.question("Enter the code from that page here: ",function(a){e.close();b.getToken(a,function(a,c){a?console.log("Error while trying to retrieve access token",a):(b.credentials=c,storeToken(c),d(b))})})}
function storeToken(b){try{fs.mkdirSync(TOKEN_DIR)}catch(d){if("EEXIST"!=d.code)throw d;}fs.writeFile(TOKEN_PATH,JSON.stringify(b));console.log("Token stored to "+TOKEN_PATH)}var complete=2,sheet_columns,sheet_rows;function getConfigValues(b,d,f,e){google.sheets("v4").spreadsheets.values.get({auth:b,spreadsheetId:d,range:f+"!B1:B2"},function(a,b){a?console.log("The API returned an error: "+a):(0==b.values.length&&console.log("No data found."),e({columns:b.values[0],rows:b.values[1]}))})}
function listMajors(b){var d=google.sheets("v4"),f=process.argv[2];getConfigValues(b,"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",f,function(e){console.log(e);d.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",range:f+"!"+e.columns},function(a,b){if(a)console.log("The API returned an error: "+a);else{var c=b.values;0==c.length?console.log("No data found."):(complete--,sheet_columns=c[0],start())}});d.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",
range:f+"!"+e.rows},function(a,b){if(a)console.log("The API returned an error: "+a);else{var c=b.values;0==c.length?console.log("No data found."):(complete--,sheet_rows=c,start())}})})}function isNumeric(b){return!isNaN(b)}
var start=function(){function b(a){if(a.category)return[' "',a.category,'"'].join("");var c={},d=['"',a.attribute," ",a.predicateName," ",a.pivot,' ?"'].join("");c[d]={yes:b(a.match),no:b(a.notMatch)};return c}function d(a){return a.category?['<ul><li><a href="#"><b>',a.category,"</b></a></li></ul>"].join(""):['<ul><li><a href="#"><b>',a.attribute," ",a.predicateName," ",a.pivot,' ?</b></a><ul><li><a href="#">yes</a>',d(a.match),'</li><li><a href="#">no</a>',d(a.notMatch),"</li></ul></li></ul>"].join("")}
if(!(0<complete)){for(var f=desobj.dt,e=[],a=0;a<sheet_rows.length;a++){for(var g=sheet_rows[a],c={},h=0;h<sheet_columns.length;h++)isNumeric(g[h])?c[sheet_columns[h].trim()]=parseFloat(g[h]):c[sheet_columns[h].trim()]=g[h];e.push(c)}fs.writeFile(basepath+"data.json",JSON.stringify(c),function(a){if(a)return console.log(a);console.log("The file was saved!")});a={trainingSet:e,categoryAttr:"action",ignoredAttributes:[]};fs.writeFile(basepath+"config.json",JSON.stringify(a),function(a){if(a)return console.log(a);
console.log("The file was saved!")});g=new f.DecisionTree(a);c=new f.RandomForest(a,3);a=e[0];fs.writeFile(basepath+"input.json",JSON.stringify(a),function(a){if(a)return console.log(a);console.log("The file was saved!")});f=g.predict(a);c=c.predict(a);console.log(JSON.stringify(a,null,0));console.log(JSON.stringify(f,null,0));console.log(JSON.stringify(c,null,0));a=b(g.root);console.log(util.inspect(a,!1,null));fs.writeFile(basepath+"tree.json",JSON.stringify(a),function(a){if(a)return console.log(a);
console.log("The file was saved!")});fs.writeFile(basepath+"tree.html",'<head><link rel="stylesheet" href="../base.css"></head><body><div class="weee" style="    width: 100%;    height: 100%;    overflow-x: scroll;    overflow-y: scroll;"><div class="tree" id="displayTree" style="    width: 9000px;    height: 9000px;"><div class="tree" id="displayTree">'+d(g.root)+"</div></div>",function(a){if(a)return console.log(a);console.log("The file was saved!")});f=0;for(a=e.length-1;0<=a;a--)c=e[a].action,
h=e[a],h.action="",g.predict(h)!=c&&f++;console.log("Error Rate:"+f/e.length*100+"%")}};
