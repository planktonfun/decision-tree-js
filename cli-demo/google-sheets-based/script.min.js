var fs=require("fs"),readline=require("readline"),google=require("googleapis"),googleAuth=require("google-auth-library"),desobj=require("./decision-tree.js"),util=require("util"),basepath="../json_files/",SCOPES=["https://www.googleapis.com/auth/spreadsheets.readonly"],TOKEN_DIR=(process.env.HOME||process.env.HOMEPATH||process.env.USERPROFILE)+"/.credentials/",TOKEN_PATH=TOKEN_DIR+"sheets.googleapis.com-nodejs-quickstart.json";
fs.readFile("client_id.json",function(b,d){b?console.log("Error loading client secret file: "+b):authorize(JSON.parse(d),listMajors)});function authorize(b,d){var a=b.installed.client_secret,e=b.installed.client_id,c=b.installed.redirect_uris[0],f=new (new googleAuth).OAuth2(e,a,c);fs.readFile(TOKEN_PATH,function(b,a){b?getNewToken(f,d):(f.credentials=JSON.parse(a),d(f))})}
function getNewToken(b,d){var a=b.generateAuthUrl({access_type:"offline",scope:SCOPES});console.log("Authorize this app by visiting this url: ",a);var e=readline.createInterface({input:process.stdin,output:process.stdout});e.question("Enter the code from that page here: ",function(a){e.close();b.getToken(a,function(a,c){a?console.log("Error while trying to retrieve access token",a):(b.credentials=c,storeToken(c),d(b))})})}
function storeToken(b){try{fs.mkdirSync(TOKEN_DIR)}catch(d){if("EEXIST"!=d.code)throw d;}fs.writeFile(TOKEN_PATH,JSON.stringify(b));console.log("Token stored to "+TOKEN_PATH)}var complete=2,sheet_columns,sheet_rows;
function listMajors(b){var d=google.sheets("v4");d.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",range:"Sheet1!A1:F1"},function(a,b){if(a)console.log("The API returned an error: "+a);else{var c=b.values;0==c.length?console.log("No data found."):(complete--,sheet_columns=c[0],start())}});d.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",range:"Sheet1!A2:F"},function(a,b){if(a)console.log("The API returned an error: "+
a);else{var c=b.values;0==c.length?console.log("No data found."):(complete--,sheet_rows=c,start())}})}function isNumeric(b){return!isNaN(b)}
var start=function(){function b(h){if(h.category)return[' "',h.category,'"'].join("");var a={},c=['"',h.attribute," ",h.predicateName," ",h.pivot,' ?"'].join("");a[c]={yes:b(h.match),no:b(h.notMatch)};return a}function d(a){return a.category?['<ul><li><a href="#"><b>',a.category,"</b></a></li></ul>"].join(""):['<ul><li><a href="#"><b>',a.attribute," ",a.predicateName," ",a.pivot,' ?</b></a><ul><li><a href="#">yes</a>',d(a.match),'</li><li><a href="#">no</a>',d(a.notMatch),"</li></ul></li></ul>"].join("")}
if(!(0<complete)){for(var a=desobj.dt,e=[],c=0;c<sheet_rows.length;c++){for(var f=sheet_rows[c],k={},g=0;g<sheet_columns.length;g++)isNumeric(f[g])?k[sheet_columns[g].trim()]=parseInt(f[g]):k[sheet_columns[g].trim()]=f[g];e.push(k)}fs.writeFile(basepath+"data.json",JSON.stringify(k),function(a){if(a)return console.log(a);console.log("The file was saved!")});c={trainingSet:e,categoryAttr:"action",ignoredAttributes:["Time"]};fs.writeFile(basepath+"config.json",JSON.stringify(c),function(a){if(a)return console.log(a);
console.log("The file was saved!")});e=new a.DecisionTree(c);f=new a.RandomForest(c,3);a={Name:"Comic guy",hitpoints:8,cost:290};fs.writeFile(basepath+"input.json",JSON.stringify(a),function(a){if(a)return console.log(a);console.log("The file was saved!")});c=e.predict(a);f=f.predict(a);console.log(JSON.stringify(a,null,0));console.log(JSON.stringify(c,null,0));console.log(JSON.stringify(f,null,0));a=b(e.root);console.log(util.inspect(a,!1,null));fs.writeFile(basepath+"tree.json",JSON.stringify(a),
function(a){if(a)return console.log(a);console.log("The file was saved!")});fs.writeFile(basepath+"tree.html",'<head><link rel="stylesheet" href="../base.css"></head><body><div class="tree" id="displayTree">'+d(e.root),function(a){if(a)return console.log(a);console.log("The file was saved!")})}};
