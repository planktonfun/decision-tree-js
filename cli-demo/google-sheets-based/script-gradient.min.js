var fs=require("fs"),readline=require("readline"),google=require("googleapis"),googleAuth=require("google-auth-library"),desobj=require("./decision-tree.js"),util=require("util"),basepath="../json_files/",SCOPES=["https://www.googleapis.com/auth/spreadsheets.readonly"],TOKEN_DIR=(process.env.HOME||process.env.HOMEPATH||process.env.USERPROFILE)+"/.credentials/",TOKEN_PATH=TOKEN_DIR+"sheets.googleapis.com-nodejs-quickstart.json";
fs.readFile("client_id.json",function(b,e){b?console.log("Error loading client secret file: "+b):authorize(JSON.parse(e),listMajors)});function authorize(b,e){var f=b.installed.client_secret,d=b.installed.client_id,a=b.installed.redirect_uris[0],g=new (new googleAuth).OAuth2(d,f,a);fs.readFile(TOKEN_PATH,function(a,b){a?getNewToken(g,e):(g.credentials=JSON.parse(b),e(g))})}
function getNewToken(b,e){var f=b.generateAuthUrl({access_type:"offline",scope:SCOPES});console.log("Authorize this app by visiting this url: ",f);var d=readline.createInterface({input:process.stdin,output:process.stdout});d.question("Enter the code from that page here: ",function(a){d.close();b.getToken(a,function(a,c){a?console.log("Error while trying to retrieve access token",a):(b.credentials=c,storeToken(c),e(b))})})}
function storeToken(b){try{fs.mkdirSync(TOKEN_DIR)}catch(e){if("EEXIST"!=e.code)throw e;}fs.writeFile(TOKEN_PATH,JSON.stringify(b));console.log("Token stored to "+TOKEN_PATH)}var complete=2,sheet_columns,sheet_rows;function getConfigValues(b,e,f,d){google.sheets("v4").spreadsheets.values.get({auth:b,spreadsheetId:e,range:f+"!B1:B2"},function(a,b){a?console.log("The API returned an error: "+a):(0==b.values.length&&console.log("No data found."),d({columns:b.values[0],rows:b.values[1]}))})}
function listMajors(b){var e=google.sheets("v4"),f=process.argv[2];getConfigValues(b,"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",f,function(d){console.log(d);e.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",range:f+"!"+d.columns},function(a,b){if(a)console.log("The API returned an error: "+a);else{var c=b.values;0==c.length?console.log("No data found."):(complete--,sheet_columns=c[0],start())}});e.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",
range:f+"!"+d.rows},function(a,b){if(a)console.log("The API returned an error: "+a);else{var c=b.values;0==c.length?console.log("No data found."):(complete--,sheet_rows=c,start())}})})}function isNumeric(b){return!isNaN(b)}
var start=function(){function b(a){if(a.category)return[' "',a.category,'"'].join("");var c={},d=['"',a.attribute," ",a.predicateName," ",a.pivot,' ?"'].join("");c[d]={yes:b(a.match),no:b(a.notMatch)};return c}function e(a){return a.category?['<ul><li><a href="#"><b>',a.category,"</b></a></li></ul>"].join(""):['<ul><li><a href="#"><b>',a.attribute," ",a.predicateName," ",a.pivot,' ?</b></a><ul><li><a href="#">yes</a>',e(a.match),'</li><li><a href="#">no</a>',e(a.notMatch),"</li></ul></li></ul>"].join("")}
if(!(0<complete)){for(var f=desobj.dt,d=[],a=0;a<sheet_rows.length;a++){for(var g=sheet_rows[a],c={},h=0;h<sheet_columns.length;h++)isNumeric(g[h])?c[sheet_columns[h].trim()]=parseFloat(g[h]):c[sheet_columns[h].trim()]=g[h];d.push(c)}fs.writeFile(basepath+"data.json",JSON.stringify(c),function(a){if(a)return console.log(a);console.log("The file was saved!")});g=3;c=0;for(h="none";0==c;){for(var k=[],a=0;a<g;a++)k.push(d[a]);var n={trainingSet:k,categoryAttr:"action",ignoredAttributes:[]};fs.writeFile(basepath+
"config.json",JSON.stringify(n),function(a){if(a)return console.log(a);console.log("The file was saved!")});try{for(var l=new f.DecisionTree(n),m=0,a=k.length-1;0<=a;a--)if(void 0!=k[a].action){var p=k[a].action,q=k[a];l.predict(q)!=p&&m++}c=m/k.length*100;0==c&&(h=n)}catch(r){console.log("an error occured")}console.log("Error Rate:"+c+"%",g);g>d.length&&(c=100);g++}l=new f.DecisionTree(h);f=b(l.root);console.log(util.inspect(f,!1,null));fs.writeFile(basepath+"tree.json",JSON.stringify(f),function(a){if(a)return console.log(a);
console.log("The file was saved!")});fs.writeFile(basepath+"tree.html",'<head><link rel="stylesheet" href="../base.css"></head><body><div class="weee" style="    width: 100%;    height: 100%;    overflow-x: scroll;    overflow-y: scroll;"><div class="tree" id="displayTree" style="    width: 9000px;    height: 9000px;"><div class="tree" id="displayTree">'+e(l.root)+"</div></div>",function(a){if(a)return console.log(a);console.log("The file was saved!")});m=0;for(a=d.length-1;0<=a;a--)void 0!=d[a].action&&
(p=d[a].action,q=d[a],l.predict(q)!=p&&m++);c=m/d.length*100;console.log("Final Error Rate:"+c+"%")}};
