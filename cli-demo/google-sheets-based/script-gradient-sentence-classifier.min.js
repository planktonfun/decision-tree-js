var fs=require("fs"),readline=require("readline"),google=require("googleapis"),googleAuth=require("google-auth-library"),desobj=require("./decision-tree.js"),util=require("util"),basepath="../json_files/",SCOPES=["https://www.googleapis.com/auth/spreadsheets.readonly"],TOKEN_DIR=(process.env.HOME||process.env.HOMEPATH||process.env.USERPROFILE)+"/.credentials/",TOKEN_PATH=TOKEN_DIR+"sheets.googleapis.com-nodejs-quickstart.json";
fs.readFile("client_id.json",function(b,d){b?console.log("Error loading client secret file: "+b):authorize(JSON.parse(d),listMajors)});function authorize(b,d){var f=b.installed.client_secret,c=b.installed.client_id,a=b.installed.redirect_uris[0],e=new (new googleAuth).OAuth2(c,f,a);fs.readFile(TOKEN_PATH,function(a,b){a?getNewToken(e,d):(e.credentials=JSON.parse(b),d(e))})}
function getNewToken(b,d){var f=b.generateAuthUrl({access_type:"offline",scope:SCOPES});console.log("Authorize this app by visiting this url: ",f);var c=readline.createInterface({input:process.stdin,output:process.stdout});c.question("Enter the code from that page here: ",function(a){c.close();b.getToken(a,function(a,c){a?console.log("Error while trying to retrieve access token",a):(b.credentials=c,storeToken(c),d(b))})})}
function storeToken(b){try{fs.mkdirSync(TOKEN_DIR)}catch(d){if("EEXIST"!=d.code)throw d;}fs.writeFile(TOKEN_PATH,JSON.stringify(b));console.log("Token stored to "+TOKEN_PATH)}
var tokenizeSentences=function(b){this.tokenization=function(a){a=String(a);a=a.replace(/[!"#\$%&\(\)\*\+,\-\.\/\:;<=>\?@\[\\\]\^_`{\|}~\t\n]/gm,"");a=a.toLowerCase();return a=a.split(" ")};for(var d=[],f=0;f<b.length;f++){for(var c=this.tokenization(b[f].Pattern),a={action:b[f].action},e=0;e<c.length;e++)void 0==a[c[e]]?a[c[e]]=1:a[c[e]]++;d.push(a)}return d},complete=2,sheet_columns,sheet_rows;
function getConfigValues(b,d,f,c){google.sheets("v4").spreadsheets.values.get({auth:b,spreadsheetId:d,range:f+"!B1:B2"},function(a,b){a?console.log("The API returned an error: "+a):(0==b.values.length&&console.log("No data found."),c({columns:b.values[0],rows:b.values[1]}))})}
function listMajors(b){var d=google.sheets("v4"),f=process.argv[2];getConfigValues(b,"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",f,function(c){console.log(c);d.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",range:f+"!"+c.columns},function(a,b){if(a)console.log("The API returned an error: "+a);else{var c=b.values;0==c.length?console.log("No data found."):(complete--,sheet_columns=c[0],start())}});d.spreadsheets.values.get({auth:b,spreadsheetId:"1Hy3rmXSarcwD7E7N-bcoJzVx8yQ9CICtjtsV_rtekvk",
range:f+"!"+c.rows},function(a,b){if(a)console.log("The API returned an error: "+a);else{var c=b.values;0==c.length?console.log("No data found."):(complete--,sheet_rows=c,start())}})})}function isNumeric(b){return!isNaN(b)}function shuffle(b){for(var d=b.length,f,c;0!==d;)c=Math.floor(Math.random()*d),d-=1,f=b[d],b[d]=b[c],b[c]=f;return b}
var start=function(){function b(a){if(a.category)return[' "',a.category,'"'].join("");var c={},d=['"',a.attribute," ",a.predicateName," ",a.pivot,' ?"'].join("");c[d]={yes:b(a.match),no:b(a.notMatch)};return c}function d(a){return a.category?['<ul><li><a href="#"><b>',a.category,"</b></a></li></ul>"].join(""):['<ul><li><a href="#"><b>',a.attribute," ",a.predicateName," ",a.pivot,' ?</b></a><ul><li><a href="#">yes</a>',d(a.match),'</li><li><a href="#">no</a>',d(a.notMatch),"</li></ul></li></ul>"].join("")}
if(!(0<complete)){for(var f=desobj.dt,c=[],a=0;a<sheet_rows.length;a++){for(var e=sheet_rows[a],k={},h=0;h<sheet_columns.length;h++)isNumeric(e[h])?k[sheet_columns[h].trim()]=parseFloat(e[h]):k[sheet_columns[h].trim()]=e[h];c.push(k)}fs.writeFile(basepath+"data.json",JSON.stringify(k),function(a){if(a)return console.log(a);console.log("The file was saved!")});for(var k=3,h=0,q=100,r="none",s=[],c=tokenizeSentences(c);0==h;){for(var c=shuffle(c),g=[],a=0;a<k;a++)-1<s.indexOf(a)||g.push(c[a]);e={trainingSet:g,
categoryAttr:"action",ignoredAttributes:[]};try{for(var m=new f.DecisionTree(e),l=0,a=e.trainingSet.length-1;0<=a;a--)if(void 0!=e.trainingSet[a].action){var n=e.trainingSet[a].action,p=e.trainingSet[a];m.predict(p)!=n&&l++}h=l/g.length*100;l=0;g=c;for(a=g.length-1;0<=a;a--)void 0!=g[a].action&&(n=g[a].action,p=g[a],m.predict(p)!=n&&l++);l/g.length*100<=q&&(q=l/g.length*100,r=e,fs.writeFileSync(basepath+"config.json",JSON.stringify(e)),console.log("The file was saved!"));0!=h&&(console.log("skipping: "+
(k-1)),s.push(k-1),console.log("total: "+l/g.length*100+"%"),h=0);console.log("Lowest total: "+q+"%")}catch(t){console.log("an error occured",t,e)}console.log("Error Rate:"+h+"%",k);k>c.length&&(h=100);k++}e=r;m=new f.DecisionTree(e);f=b(m.root);console.log(util.inspect(f,!1,null));fs.writeFile(basepath+"config.json",JSON.stringify(e),function(a){if(a)return console.log(a);console.log("The file was saved!")});fs.writeFile(basepath+"tree.json",JSON.stringify(f),function(a){if(a)return console.log(a);
console.log("The file was saved!")});fs.writeFile(basepath+"tree.html",'<head><link rel="stylesheet" href="../base.css"></head><body><div class="weee" style="    width: 100%;    height: 100%;    overflow-x: scroll;    overflow-y: scroll;"><div class="tree" id="displayTree" style="    width: 9000px;    height: 9000px;"><div class="tree" id="displayTree">'+d(m.root)+"</div></div>",function(a){if(a)return console.log(a);console.log("The file was saved!")});l=0;g=c;for(a=g.length-1;0<=a;a--)void 0!=g[a].action&&
(n=g[a].action,p=g[a],m.predict(p)!=n&&l++);h=l/g.length*100;console.log("Final Error Rate:"+h+"%")}};
